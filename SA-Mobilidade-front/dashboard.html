<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mobilidade Urbana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .app-bg { background-color: #e2e8f0; }
        .card-bg { background-color: #dbeafe; }
        .accent-bg { background-color: #3b82f6; }
        .accent-text { color: #3b82f6; }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-md mx-auto min-h-screen app-bg shadow-lg">

        <!-- ===== HEADER ===== -->
        <header class="sticky top-0 z-10 w-full bg-white shadow-md">
            <div class="flex items-center justify-between h-16 px-4">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-6 0V6a1.5 1.5 0 0 1 1.5-1.5h3v5.25m0 0a1.5 1.5 0 0 1 3 0m-3 0a1.5 1.5 0 0 0 3 0m-3 0h6m-6 0V6a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 21 6v12.75m-18 0a1.5 1.5 0 0 0 1.5 1.5h15a1.5 1.5 0 0 0 1.5-1.5m-18 0v-6A1.5 1.5 0 0 1 4.5 12h15a1.5 1.5 0 0 1 1.5 1.5v6" /></svg>
                    <span class="ml-2 text-xl font-bold text-gray-800">SICOGF</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-600 hover:text-blue-600"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></button>
                    <button class="text-gray-600 hover:text-blue-600"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.31 5.772 23.848 23.848 0 0 0 5.454 1.31Aa3.003 3.003 0 0 0 5.714 0Z" /></svg></button>
                    <div class="relative">
                        <button id="profile-button" class="text-gray-600 hover:text-blue-600"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></button>
                        <div id="logout-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-20">
                            <div class="p-2">
                                <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">Sair</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ===== CONTEÚDO PRINCIPAL ===== -->
        <main class="p-4 space-y-4">

            <!-- ***** MENSAGEM DE ERRO (NOVO) ***** -->
            <div id="dashboard-error" class="hidden p-4 rounded-lg bg-red-100 text-red-700 text-sm shadow">
                <!-- Mensagens de erro do dashboard aparecerão aqui -->
            </div>
            
            <!-- Card 1: Banner -->
            <div class="relative w-full h-32 bg-blue-500 rounded-lg overflow-hidden shadow">
                <div class="absolute inset-0 opacity-10"><svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 40" preserveAspectRatio="none"><g fill="white"><path d="M5 5h10v5H5z M25 5h10v5H25z M45 5h10v5H45z M65 5h10v5H65z M15 15h10v5H15z M35 15h10v5H35z M55 15h10v5H55z M75 15h10v5H75z M5 25h10v5H5z M25 25h10v5H25z M45 25h10v5H45z M65 25h10v5H65z M15 35h10v5H15z M35 35h10v5H35z M55 35h10v5H55z M75 35h10v5H75z"></path></g></svg></div>
                <div class="absolute inset-0 flex items-center justify-center"><h2 class="text-xl font-bold text-white text-center px-4">Conectando destinos,<br>facilitando trajetos</h2></div>
            </div>

            <!-- Card 2: Identificação Cartão -->
            <div class="card-bg rounded-lg p-4 space-y-4 shadow">
                <div class="flex items-center space-x-2"><svg class="h-6 w-6 text-blue-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h6m-6 2.25h6M2.25 9.75v10.5a.75.75 0 0 0 .75.75h19.5a.75.75 0 0 0 .75-.75V9.75M3 7.5h18M3 7.5v-1.5A.75.75 0 0 1 3.75 5.25h16.5a.75.75 0 0 1 .75.75V7.5m-18 0v-1.5a.75.75 0 0 1 .75-.75H12" /></svg><span class="font-bold text-blue-800">Seu cartão</span></div>
                <h3 class="text-xl font-bold text-gray-800">Identificação Cartão</h3>
                <span id="card-number" class="text-gray-700">Carregando...</span>
                <div class="flex items-start space-x-4">
                    <div class="flex-1 bg-blue-600 rounded-lg p-4 text-white shadow-inner">
                        <div class="flex items-center justify-between"><span class="text-3xl font-bold" id="saldo-display">R$ ********</span><button id="toggle-saldo" class="text-blue-100 hover:text-white"><svg id="icon-eye-visible" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg><svg id="icon-eye-hidden" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.22 16.338 7.244 19.5 12 19.5c.99 0 1.953-.138 2.863-.395M6.228 6.228A10.46 10.46 0 0 1 12 4.5c4.756 0 8.78 3.162 10.065 7.498a10.523 10.523 0 0 1-4.293 5.77M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.243 4.243L6.228 6.228" /></svg></button></div><span class="text-sm text-blue-100">Saldo Disponível</span>
                    </div>
                    <div class="flex flex-col space-y-2"><button class="flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700"><span>Recarregar</span><svg class="h-5 w-5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182.997-.75 2.342-.75 3.339 0L12 12.01M12 6v12" /></svg></button><button class="px-4 py-2 bg-white text-blue-600 rounded-lg font-semibold shadow hover:bg-gray-50 border border-blue-600">Repetir Recarga</button></div>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-600"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><span id="last-use">Última utilização em: --/--/----</span></div>
            </div>

            <!-- Card 3: Informações -->
            <div class="card-bg rounded-lg p-4 space-y-4 shadow">
                <div class="flex items-center space-x-2"><svg class="h-6 w-6 text-blue-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg><span class="font-bold text-blue-800">Informações</span></div>
                <div class="bg-white/70 rounded-lg p-3"><h4 class="font-bold text-gray-800">Sobre Nossa Empresa</h4><p class="text-sm text-gray-700 mt-1">A Sicogf é a principal empresa de transporte público da Grande Florianópolis, oferecendo viagens seguras, confiáveis e pontuais. Com frota moderna e atendimento de qualidade, conectamos você aos seus destinos com eficiência.</p></div>
                <div class="bg-white/70 rounded-lg p-3"><h4 class="font-bold text-gray-800">Empresas de Ônibus</h4><div class="flex items-center justify-around space-x-2 mt-2"><span class="text-lg font-semibold text-gray-600 italic">JOTUR</span><span class="text-lg font-semibold text-gray-600 italic">Biguaçu</span><span class="text-lg font-semibold text-gray-600 italic">Estrela</span></div></div>
            </div>

        </main>
    </div>

    <script>
        // Função para mostrar erros no dashboard
        function mostrarErro(mensagem) {
            const errorDiv = document.getElementById('dashboard-error');
            errorDiv.textContent = mensagem;
            errorDiv.classList.remove('hidden');
            // Role para o topo para ver o erro
            window.scrollTo(0, 0);
        }

        // Função para redirecionar para o login
        function redirecionarParaLogin(mensagem) {
            localStorage.removeItem('token');
            localStorage.removeItem('usuario');
            // Salva a mensagem de erro para mostrá-la no login (opcional)
            sessionStorage.setItem('loginError', mensagem);
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const usuario = JSON.parse(localStorage.getItem('usuario'));

            // --- 1. GUARDA DE AUTENTICAÇÃO (SEM ALERT) ---
            if (!token || !usuario) {
                // Não use alert. Apenas redirecione.
                console.error("Não autorizado. Redirecionando para login.");
                redirecionarParaLogin('Você precisa estar logado para ver esta página.');
                return; // Para a execução do script
            }

            // --- 2. LÓGICA DE LOGOUT (Sem mudanças) ---
            const profileButton = document.getElementById('profile-button');
            const logoutMenu = document.getElementById('logout-menu');
            const logoutButton = document.getElementById('logout-button');

            profileButton.addEventListener('click', () => logoutMenu.classList.toggle('hidden'));
            logoutButton.addEventListener('click', () => redirecionarParaLogin('Logout realizado com sucesso.'));
            
            document.addEventListener('click', (event) => {
                if (!profileButton.contains(event.target) && !logoutMenu.contains(event.target)) {
                    logoutMenu.classList.add('hidden');
                }
            });

            // --- 3. LÓGICA DE MOSTRAR/OCULTAR SALDO (Sem mudanças) ---
            const toggleSaldoBtn = document.getElementById('toggle-saldo');
            const saldoDisplay = document.getElementById('saldo-display');
            const iconVisible = document.getElementById('icon-eye-visible');
            const iconHidden = document.getElementById('icon-eye-hidden');
            let saldoOculto = true;
            let saldoValor = 0.00;

            toggleSaldoBtn.addEventListener('click', () => {
                saldoOculto = !saldoOculto;
                if (saldoOculto) {
                    saldoDisplay.textContent = 'R$ ********';
                    iconVisible.classList.remove('hidden');
                    iconHidden.classList.add('hidden');
                } else {
                    saldoDisplay.textContent = `R$ ${saldoValor.toFixed(2)}`;
                    iconVisible.classList.add('hidden');
                    iconHidden.classList.remove('hidden');
                }
            });

            // --- 4. BUSCAR DADOS DO CARTÃO (COM MELHOR TRATAMENTO DE ERRO) ---
            const cardNumberDisplay = document.getElementById('card-number');
            const lastUseDisplay = document.getElementById('last-use');

            try {
                const response = await fetch('http://localhost:3000/api/cartoes/meus-cartoes', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    // Se a resposta não for OK, lança um erro com a mensagem do back-end
                    throw new Error(data.mensagem || `Erro ${response.status}`);
                }

                // SUCESSO AO BUSCAR CARTÕES
                if (data.length > 0) {
                    const cartao = data[0];
                    saldoValor = parseFloat(cartao.saldo);
                    cardNumberDisplay.textContent = `**** **** **** ${cartao.numero_cartao.slice(-4)}`;
                    lastUseDisplay.textContent = 'Última utilização em: 10/11/2025'; // Simulado
                } else {
                    cardNumberDisplay.textContent = 'Nenhum cartão encontrado.';
                    saldoDisplay.textContent = 'R$ 0.00';
                    mostrarErro('Você está logado, mas ainda não cadastrou um cartão.');
                }

            } catch (error) {
                console.error('Erro na API do dashboard:', error);

                // Se o erro for de autorização (401), chuta para o login
                if (error.message.includes('401') || error.message.includes('token')) {
                    redirecionarParaLogin('Sua sessão expirou. Faça o login novamente.');
                } else {
                    // Mostra outros erros (ex: "Falha ao buscar") no dashboard
                    mostrarErro(`Erro ao carregar dados: ${error.message}`);
                }
            }
        });
    </script>
</body>
</html>